#################################################################
## SECTION: Deployment targets on servers using docker compose (locally on servers)
#################################################################
deployment_mode := $(shell cat ub2.toml | grep DeploymentMode | awk '{print $$3}')
daemonized_deployment_mode := $(shell cat ub2-daemonized.toml | grep DeploymentMode | awk '{print $$3}')

deploy: ensure-ria-network ## Deploys in offline mode (images need to be loaded preliminarly with docker load -i <images_tarball>)
	$(DEPLOYER_COMPOSE) up --abort-on-container-exit --force-recreate

deploy-daemon: ensure-ria-network-daemonized ## Deploys in daemon mode watching for remote git changes on the delivery repository
	$(DAEMON_DEPLOYER_COMPOSE) up -d --force-recreate

force-redeploy-daemon: ensure-ria-network-daemonized ## Force redeploys in daemon mode on the same git commit
	$(DAEMON_DEPLOYER_COMPOSE) down -v
	$(DAEMON_DEPLOYER_COMPOSE) up -d

deployer-daemon-logs: ## Get the deployer daemon logs
	$(DAEMON_DEPLOYER_COMPOSE) logs --timestamps --tail=100 --follow

ensure-ria-network: ## Ensures the 'ria' docker network required for deployments exists
	docker network create ria >/dev/null 2>&1 || true

ensure-ria-network-daemonized: ## Ensures the 'ria' docker network required for daemonized deployments exists
	docker network create ria >/dev/null 2>&1 || true

clean-deployment: ensure-ria-network ## Resets a standalone deployment stack
	$(DEPLOYER_COMPOSE) run ub2 -c

clean-deployer: ensure-ria-network ## Resets a standalone deployer
	$(DEPLOYER_COMPOSE) down -v

clean: ensure-ria-network clean-deployment clean-deployer ## Fully resets a standalone deployment
	docker network rm ria

clean-daemonized-deployment: ensure-ria-network-daemonized ## Resets a daemonized deployment stack
	$(DAEMON_DEPLOYER_COMPOSE) run ub2 -c

clean-daemonized-deployer: ensure-ria-network-daemonized ## Resets a daemonized deployer
	$(DAEMON_DEPLOYER_COMPOSE) down -v

clean-daemonized: ensure-ria-network-daemonized clean-deployment clean-deployer ## Fully resets a daemonized deployment
	docker network rm ria
